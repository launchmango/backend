<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <link href='http://fonts.googleapis.com/css?family=Roboto:400,900,300,600' rel='stylesheet' type='text/css'>
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Fuji â€” Not your average apple.</title>

  <link rel="stylesheet" href="/static/reset.css" type="text/css" />
  <link rel="stylesheet" href="/static/style.css" type="text/css" />

</head>
<body>
  <div class="sidebar">
      <h2>Projects</h2><div class="add-files"><a class="plus" id="clone-repository" href="">+</a></div>

         <ul id="repos">
            <li><a href="">freya-on-a-mac</a></li>
            
            <li >hackerchat
                <ul>
                <li><a href="">filename.eorj</a></li>
                <li><a href="">filename.name</a></li>
                <li>noidea.js
                    <ul>
                    <li><a href="">filename.eorj</a></li>
                <li><a href="">filename.name</a></li>
                <li><a href="">noidea.js</a></li>
               </ul></li>
              </ul></li>
                <li><a href="">PennAppsApps</a></li>
          </ul>

       <a href="/"><div class="log-out"><h2>Log out</h2></div></a>
    </div>

<pre id="editor">
#import "AppDelegate.h"
#import "ContentController.h"
 
@interface AppDelegate ()
@property (nonatomic, strong) IBOutlet ContentController *contentController;
@end
 
@implementation AppDelegate
 
- (void)applicationDidFinishLaunching:(UIApplication *)application
{
    _window = [[UIWindow alloc] initWithFrame:[[UIScreen mainScreen] bounds]];
    
    // decide which kind of content we need based on the device idiom,
    // when we load the proper nib, the "ContentController" class will take it from here
    //
    NSString *nibTitle = @"PadContent";
    if (UI_USER_INTERFACE_IDIOM() == UIUserInterfaceIdiomPhone)
    {
        nibTitle = @"PhoneContent";
    }
    [[NSBundle mainBundle] loadNibNamed:nibTitle owner:self options:nil];
    
    [self.window makeKeyAndVisible];
}
 
@end
</pre>

<div class="bottombar">
   <div class="logo">
      <a href="/"><img src="/static/logo-03.png"></a>
    </div>

    <div class="update">
      <p>Saved at 11:34</p>
    </div>

    <div class="run-button" id="run-button">
      <p>Run<img src="http://www.radiobilly.com/wp-content/themes/radiobilly/img/play-white.png"></p>
    </div>

    <div class="commit-button", id="commit-button">
      <p>Commit</p> 
    </div>
</div>

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script src="/static/js/underscore.js"></script>
<script src="/static/js/backbone.js"></script>
<script src="/static/js/handlebars.js"></script>
<script src="/static/js/moment.js"></script>
<script src="/static/js/async.js"></script>
<script src="/static/js/listcollapse.js"></script>
<script src="/static/ace/ace.js"></script>
<script src="/static/ace/ext-themelist.js"></script>

<script id="repos-list-template" type="text/x-handlebars-template">
  {{#each repositories}}
    <li><a href="#{{id}}">{{name}}</a></li>
    {{{recursiveBitch files}}}
{{!--     {{#each files}}
      <li><a href="#{{id}}">{{name}}</a></li>
    {{/each}} --}}
  {{/each}}
{{!--   <li><a href="">freya-on-a-mac</a></li>
  
  <li>hackerchat
      <ul>
        <li><a href="">filename.eorj</a></li>
        <li><a href="">filename.name</a></li>
        <li>noidea.js
            <ul>
            <li><a href="">filename.eorj</a></li>
        <li><a href="">filename.name</a></li>
        <li><a href="">noidea.js</a></li>
     </ul>
   </li>
  </ul></li>

  <li><a href="">PennAppsApps</a></li> --}}
</script>

<script>
// create first editor
var editor = ace.edit("editor");
editor.setTheme("ace/theme/twilight");
editor.session.setMode("ace/mode/objectivec");
editor.renderer.setScrollMargin(10, 10);
editor.setOptions({
  // "scrollPastEnd": 0.8,
  autoScrollEditorIntoView: true
});

editor.setFontSize(16);

var count = 1;
function add() {
  var oldEl = editor.container
  var pad = document.createElement("div")
  pad.style.padding = "40px"
  oldEl.parentNode.insertBefore(pad, oldEl.nextSibling)

  var el = document.createElement("div")
  oldEl.parentNode.insertBefore(el, pad.nextSibling)

  count++
  var theme = themes[Math.floor(themes.length * Math.random() - 1e-5)]
  editor = ace.edit(el)
  editor.setOptions({
    mode: "ace/mode/javascript",
    theme: theme,
    autoScrollEditorIntoView: true
  })

  editor.setValue([
    "this is editor number: ", count, "\n",
    "using theme \"", theme, "\"\n",
    ":)"
  ].join(""), -1)

  scroll()
}

var themes = require("ace/ext/themelist").themes.map(function(t){return t.theme});

window.add = add;
window.scroll = scroll;

function listRepositories(callback) {
  $.ajax({
    type: "GET",
    url: '/repositories',
    success: function (repositories) {
      console.log(repositories)
      callback(null, repositories)
    },
    error: function (jqXHR, textStatus) {
      callback(textStatus);
    },
    dataType: 'json'
  });
};

function getRepo(id, callback) {
  $.ajax({
    type: "GET",
    url: '/repositories/' + id,
    success: function (repositories) {
      console.log(arguments);
      callback(null, repositories);
    },
    error: function (jqXHR, textStatus) {
      callback(textStatus);
    },
    dataType: 'json'
  });
};

function getRepoFile(id, path, callback) {
  $.ajax({
    type: "GET",
    url: '/repositories/' + id + 'files/' + path,
    success: function (repositories) {
      callback(null, repositories)
    },
    error: function (jqXHR, textStatus) {
      callback(textStatus);
    },
    dataType: 'json'
  });
};

function buildRepository(id, callback) {
  $.ajax({
    type: "POST",
    url: '/repositories/' + id + '/build',
    success: function (response) {
      callback(null, response);
    },
    error: function (jqXHR, textStatus) {
      callback(textStatus);
    }
  });
};

function runRepository(id, callback) {
  $.ajax({
    type: "GET",
    url: '/repositories/' + id + '/run',
    success: function (response) {
      callback(null, response);
    },
    error: function (jqXHR, textStatus) {
      callback(textStatus);
    }
  });
};

function deleteRepository(id, callback) {
  $.ajax({
    type: 'DELETE',
    url: '/repositories/' + id,
    error: function (jqXHR, textStatus) {
      callback(textStatus);
    },
    success: function (response) {
      callback(null);
    }
  });
};

function addRepository(url, callback) {
  $.ajax({
    type: 'POST',
    url: '/repositories',
    data: JSON.stringify({url: url}),
    error: function (jqXHR, textStatus) {
      callback(textStatus);
    },
    success: function (response) {
      callback(null, response);
    },
    dataType: 'json'
  });
};

Handlebars.registerHelper('recursiveBitch', function(files) {
  console.log("CALLED ONE TIME");
  console.log(files);

  // <ul>
  //     <li><a href="">{{file.name}}</a></li>
  //     <li><a href="">filename.name</a></li>
  //     <li>noidea.js
  //       <ul>
  //         <li><a href="">filename.eorj</a></li>
  //       </ul>
  //     <li><a href="">filename.name</a></li>
  //     <li><a href="">noidea.js</a></li>
  // </ul>

  function recurseDirectory(str, files) {
    console.log('called');
    str += "<ul>";
    _.each(files, function (file) {
      console.log(file);
      str += "<li>";
      if (file.type === 'file') {
        console.log(file.name, "is a file");
        str += "<a href='#'>" + file.name + '</a>';
      } else {
        console.log(file.name, "is a directory");
        str += "<a href='#'>" + '> ' + file.name + '</a>';
        // console.log(recurseDirectory(str, file.children));
      }
      str += "</li></a>"
    });
    return str + "</ul>";
  }

  return recurseDirectory("", files.children);


  // str = "";
  // str += "<ul>";
  // _.each(files.children, function (file) {
  //   str += "<li><a>";
  //   console.log(file);
  //   if (file.type === 'file') {
  //     console.log(file.name, "is a file");
  //   } else {
  //     console.log(file.name, "is a directory");
  //     // recurse(file.children)
  //   }
  //   str += "</li></a>"
  // });
  // str += "</ul>";

});

var AppView = Backbone.View.extend({
  el: 'body',
  currentRepo: null,
  lastSaved: moment(),
  repos: [],

  events: {
      "click #run-button": "run",
      "click #clone-repository": "clone",
      "click #commit-button": "commit",
      // "click .button.delete": "destroy"
  },

  initialize: function () {
    this.reposView = new ReposListView();
    var that = this;
    this.updateRepos(function() {
      that.render();
    });
    setInterval(function () {
      that.updateSavedAt();
    }, 2500);
  },

  render: function() {
    this.reposView.render();
  },

  updateRepos: function(callback) {
    var that = this;
    listRepositories(function (err, repos) {
      if (err) return alert("SOMETHING TERRIBLE HAPPENED.");
      that.repos = repos;
      console.log("updateRepos() callback")
      callback();
    });
  },

  run: function (event) {
    console.log('run() called')
    if (!this.currentRepo) return;

    var button = $(event.target).children('p').first();

    $("#run-button").addClass("run-active");

    button.text("building...");

    var that = this;
    async.waterfall([

      function build(next) {
        buildRepository(that.currentRepo, next);
      },

      function run(next) {
        button.text("running...")
        runRepository(that.currentRepo, next);
      }
    ], function done(err) {
        if (err) {
          button.text("build failed");
          $("#run-button").removeClass("*");
          $("#run-button").addClass("build-fail");
          console.log("WATERFALL ERR", err);
          return;
        }
        button.text("stop")
    });
  },

  clone: function (event) {
    var url = prompt("Enter Git URL, ex: https://github.com/org/repo.git");
    addRepository(url, function (err, response) {
      if (err) return alert(err);
      console.log("clone successful:", response);
    });
    return false;
  },

  commit: function (event) {
    alert("Commit not implemented!");
  },

  updateSavedAt: function () {
    $(".update > p").text("last saved " + this.lastSaved.from(moment()));
  }

});

var ReposListView = Backbone.View.extend({

  el: "#repos",

  template: function(repos) {
    var source = $("#repos-list-template").html();
    return Handlebars.compile(source)({
      repositories: repos
    });
  },

  events: {
    "click a": "open",
    // "click .button.edit":   "openEditDialog",
    // "click .button.delete": "destroy"
  },

  initialize: function() {
  },

  render: function() {
    var html = this.template(window.appView.repos);
    this.$el.html(html);
    compactMenu('repos', true, '&#128194');
  },

  open: function(event) {
    var target = $(event.target);
    var id = target.attr('href').substring(1);
    this.$("a").removeClass("active");
    document.title = id;
    target.addClass("active");
    window.appView.currentRepo = id;
  }

});

window.appView = new AppView();
</script>
</body>
</html>
